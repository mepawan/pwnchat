(function(e,d,a,f){var c={firefox:false},b={};c.init=function(g){c.config=g.rtc;if(navigator.mozGetUserMedia){c.firefox=true}b=g};c._socket=null;c._events={};c.on=function(g,h){c._events[g]=c._events[g]||[];c._events[g].push(h)};c.fire=function(h,k){c.debug("fired ["+h+"]");var m=c._events[h];var j=Array.prototype.slice.call(arguments,1);if(!m){return}for(var l=0,g=m.length;l<g;l++){m[l].apply(null,j)}};c.connections={};c.id=null;c.compatible=true;c.debug=function(g){if(b.debug){console.log(g)}};c.checkCompatibility=function(i,h,g){if(!g){g="call"}c.compatible=true;if(!d.WebSocket){i.websocket=true;c.compatible=false}if(!d.RTCPeerConnection&&!d.PeerConnection){if(g=="call"){i.peerconnection=true;c.compatible=false}else{h.peerconnection=true}}if(!navigator.getUserMedia){if(g=="call"){i.usermedia=true;c.compatible=false}else{h.usermedia=true}}return c.compatible};c.connect=function(g){c._socket=new WebSocket(g);c._socket.onopen=function(){c.fire("connected")};c._socket.onmessage=function(i){var h=JSON.parse(i.data);c.debug("RECEIVED MESSAGE "+h.type);c.debug(h);c.fire(h.type,h.data)};c._socket.onerror=function(h){c.debug("onerror");c.debug(h);c.fire("socket_error",h)};c._socket.onclose=function(h){c.fire("socket_closed",{})}};c.on("connections",function(g){c.connections=g});c.on("connectionId",function(g){c.id=g.connectionId;c.fire("logged",g.data)});c.on("connection_add",function(g){c.connections[g.connectionId]=g.data});c.on("connection_remove",function(g){delete c.connections[g.connectionId]});c.on("call_invite",function(g){c.setStatus(g.connectionId,"call_invited")});c.on("call_accept",function(g){if(c.refuseIdleState(g.connectionId)){return false}c.setStatus(g.connectionId,"call_accepted");c.sdpOffer(g.connectionId)});c.setStatus=function(h,g){c.debug("status ["+g+"] for connectionId: "+h);c.connections[h].status=g;c.fire("status",h,g)};c.refuseIdleState=function(h){var g=h&&c.connections[h].status=="idle";if(g){c.debug("refusing idle state of connection id: "+h)}return g};c.send=function(g){c.debug("SENDING MSG "+g.type);c.debug(g);c._socket.send(JSON.stringify(g))};c.mediaReady=function(){c.send({type:"media_ready",data:{}})};c.rouletteNext=function(){c.send({type:"roulette_next",data:{}})};c.rouletteAccept=function(g){c.send({type:"roulette_accept",data:{connectionId:g}})};c.chatMessage=function(g,h){c.send({type:"chat_message",data:{connectionId:g,message:h}})};c.login=function(g){c.send({type:"login",data:g})};c.invite=function(h,g){c.debug("creating local media stream");c.setStatus(h,"call_inviting");c.createStream(h,g,function(i){c.debug("inviting call for id: "+h);c.send({type:"call_invite",data:{connectionId:h}})})};c.accept=function(h,g){c.debug("creating local media stream");c.createStream(h,g,function(i){c.debug("accepting call from id: "+h);c.send({type:"call_accept",data:{connectionId:h}});c.setStatus(h,"call_accepting")})};c.drop=function(h,g,i){c.debug("droping call");c.send({type:"call_drop",data:{connectionId:h}});if(c.connections[h]){c.stop(h,g,i)}};c.busy=function(g){c.debug("sending busy signal");c.send({type:"call_busy",data:{connectionId:g}})};c.stop=function(h,g,i){if(!c.connections[h]){return false}if(!g&&c.connections[h].pc){c.connections[h].pc.close();c.connections[h].pc=null}if(!i&&c.connections[h].stream){c.connections[h].stream.stop()}c.setStatus(h,"idle")};c.mergeConstraints=function(i,h){var g=i;for(var j in h.mandatory){g.mandatory[j]=h.mandatory[j]}g.optional.concat(h.optional);return g};c.onCreateSessionDescriptionError=function(g){c.debug("Failed to create session description: "+g.toString())};c.extractSdp=function(h,i){var g=h.match(i);return(g&&g.length==2)?g[1]:null};c.setDefaultCodec=function(h,l){var k=h.split(" ");var m=new Array();var g=0;for(var j=0;j<k.length;j++){if(g===3){m[g++]=l}if(k[j]!==l){m[g++]=k[j]}}return m.join(" ")};c.removeCN=function(h,m){var k=h[m].split(" ");for(var g=h.length-1;g>=0;g--){var l=c.extractSdp(h[g],/a=rtpmap:(\d+) CN\/\d+/i);if(l){var j=k.indexOf(l);if(j!==-1){k.splice(j,1)}h.splice(g,1)}}h[m]=k.join(" ");return h};c.preferAudioCodec=function(h){if(!c.config.audio_receive_codec){return h}var n=c.config.audio_receive_codec;var k=n.split("/");if(k.length!=2){return h}var g=k[0];var l=k[1];var p=h.split("\r\n");for(var j=0;j<p.length;j++){if(p[j].search("m=audio")!==-1){var q=j;break}}if(q===null){return h}for(var j=0;j<p.length;j++){if(p[j].search(g+"/"+l)!==-1){var m=new RegExp(":(\\d+) "+g+"\\/"+l,"i");var o=c.extractSdp(p[j],m);if(o){p[q]=c.setDefaultCodec(p[q],o)}break}}p=c.removeCN(p,q);h=p.join("\r\n");return h};c.remoteSDReceive=function(g,h){g.setRemoteDescription(new RTCSessionDescription(h),function(){c.debug("Set remote session description success.");var i=g.getRemoteStreams();if(i.length>0&&i[0].getVideoTracks().length>0){c.debug("Waiting for remote video tracks")}},function(i){c.debug("Set remote session description error "+i.toString())})};c.localSDSend=function(g,j,i,h){i.sdp=c.preferAudioCodec(i.sdp);c.debug("Setting local sessionDescription and sending msg "+h);c.debug(i);g.setLocalDescription(i,function(){c.debug("Set local session description success.")},function(k){c.debug("Set local session description error "+k.toString())});c.send({type:h,data:{connectionId:j,sdp:i}})};c.sdpOffer=function(h){var g=c.createPeerConnection(h);var i=c.mergeConstraints(c.config.offerConstraints,c.config.sdpConstraints);c.debug("Sending offer to peer, with constraints: \n  '"+JSON.stringify(i)+"'.");g.createOffer(function(j){c.localSDSend(g,h,j,"sdp_offer")},c.onCreateSessionDescriptionError,i);c.setStatus(h,"sdp_offering")};c.sdpAnswer=function(h){c.debug("Answering call connectionId: "+h);var g=c.createPeerConnection(h);c.remoteSDReceive(g,c.connections[h].offerSdp);c.debug("Sending answer to peer, with constraints: \n  '"+JSON.stringify(c.config.sdpConstraints)+"'.");g.createAnswer(function(i){c.localSDSend(g,h,i,"sdp_answer")},c.onCreateSessionDescriptionError,c.config.sdpConstraints);c.setStatus(h,"sdp_answering")};c.createStream=function(h,g,k,l){k=k||function(m){};l=l||function(m){c.debug("Could not connect stream with error:");c.debug(m)};try{c.fire("media_request_start");var j=e.extend({},c.config.mediaConstraints,g);navigator.getUserMedia(j,function(m){c.fire("media_request_end");if(c.refuseIdleState(h)){m.stop();return false}if(h){c.connections[h].stream=m}c.fire("stream_added",m,h);k(m)},function(m){c.fire("media_request_end");l(m);c.fire("stream_error",m)})}catch(i){c.fire("media_request_end");c.fire("stream_error",i)}};c.createPeerConnection=function(h){c.debug("createPeerConnection for id: "+h);try{c.connections[h].pc=new d.RTCPeerConnection(c.config.pcConfig,c.config.pcConstraints);c.connections[h].pc.onicecandidate=function(j){c.debug("pc.onicecandidate, event:");c.debug(j);if(j.candidate){c.send({type:"ice_candidate",data:{candidate:j.candidate.candidate,connectionId:h,label:j.candidate.sdpMLineIndex}})}else{c.debug("End of ICE candidates")}};c.debug("Created RTCPeerConnnection with:\n  config: '"+JSON.stringify(c.config.pcConfig)+"';\n  constraints: '"+JSON.stringify(c.config.pcConstraints)+"'.")}catch(i){c.debug("Failed to create RTCPeerConnection, exception: "+i.message);c.fire("pc_error",i);alert("Cannot create PeerConnection object; Is the 'PeerConnection' flag enabled in about:flags?");return null}var g=c.connections[h].pc;g.onconnecting=function(){c.debug("Session connecting.")};g.onopen=function(){c.debug("Session opened.");c.fire("pc_opened",h)};g.onaddstream=function(j){c.debug("Remote stream added.");c.fire("rstream_added",j.stream,h);c.setStatus(h,"call")};g.onremovestream=function(){c.debug("Remote stream removed.")};if(c.connections[h].stream){g.addStream(c.connections[h].stream)}g.onsignalingstatechange=function(){c.debug("PC Signaling state changed to: "+g.signalingState)};g.oniceconnectionstatechange=function(){c.debug("ICE connection state changed to: "+g.iceConnectionState)};return g};c.fileOffer=function(h,g){c.debug("offering file to connection "+h);c.debug(g);c.send({type:"file_offer",data:{connectionId:h,fileDesc:g}})};c.fileAccept=function(h,g){c.debug("accepting file from id: "+h);c.debug(g);c.send({type:"file_accept",data:{connectionId:h,fileDesc:g}})};c.fileCancel=function(h,g){c.debug("canceling file sending to "+h);c.debug(g);c.send({type:"file_cancel",data:{connectionId:h,fileDesc:g}})};c.fileSdpOffer=function(j,i,h){var g=c.fileGetPeerConnection(j,h,true);var k=c.mergeConstraints(c.config.offerConstraints,c.config.sdpConstraints);g.createOffer(function(l){g.setLocalDescription(l);c.send({type:"file_sdp_offer",data:{connectionId:j,sdp:l,fileDesc:i}})},function(l){c.debug("Failed to create session description offer: "+l.toString())},k)};c.fileSdpAnswer=function(j,i,h){c.debug("Answering call connectionId: "+j);var g=c.fileGetPeerConnection(j,h);var k=c.mergeConstraints(c.config.offerConstraints,c.config.sdpConstraints);g.setRemoteDescription(new RTCSessionDescription(c.connections[j].fileOfferSdp));g.createAnswer(function(l){g.setLocalDescription(l);c.send({type:"file_sdp_answer",data:{connectionId:j,sdp:l,fileDesc:i}})},function(l){c.debug("Failed to create session description answer: "+l.toString())},k)};c.fileGetPeerConnection=function(l,i,k){try{c.debug("fileGetPeerConnection for id: "+l+" does not exist, creating it");if(!c.firefox){var n={optional:[{RtpDataChannels:true}]}}else{var n={optional:[]}}c.connections[l].dpc=new d.RTCPeerConnection(c.config.pcConfig,n);c.connections[l].dpc.onicecandidate=function(o){if(o.candidate){c.send({type:"file_ice_candidate",data:{candidate:o.candidate.candidate,connectionId:l,label:o.candidate.sdpMLineIndex}})}}}catch(m){c.debug("Failed to create RTCPeerConnection, exception: "+m.message);c.fire("dpc_error",m);alert("Cannot create PeerConnection object; Is the 'PeerConnection' flag enabled in about:flags?");return null}var h=c.connections[l].dpc;h.onopen=function(){c.debug("File peerconnection opened for conn id: "+l)};var j=function(o){if(i.channelOnMessage){o.onmessage=i.channelOnMessage}if(i.channelOnOpen){o.onopen=i.channelOnOpen}if(i.channelOnClose){o.onclose=i.channelOnClose}if(i.channelOnError){o.onerror=i.channelOnError}};var g=function(){if(!k){return false}c.debug("creating send channel");var o=(c.firefox)?{}:{reliable:false};c.connections[l].sendChannel=c.connections[l].dpc.createDataChannel("sendDataChannel"+l,o);if(c.firefox){c.connections[l].sendChannel.binaryType="blob"}j(c.connections[l].sendChannel)};h.ondatachannel=function(o){if(!k){c.debug("creating receive channel");c.connections[l].receiveChannel=o.channel;if(c.firefox){c.connections[l].receiveChannel.binaryType="blob"}j(c.connections[l].receiveChannel)}};g();return h};c.fileReceiveProgress=function(h,g,i){c.send({type:"file_receive_progress",data:{connectionId:h,fileId:g,packets:i}})};c.on("file_ice_candidate",function(h){var g=c.connections[h.connectionId].dpc;g.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:h.label,candidate:h.candidate}))});e.fn.mgRtc=function(g){c.init(g);return c}})(jQuery,window,document);(function(c,b,a,d){c.fn.mgFileHelper=function(e){var f={getDesc:function(g){if(!g.id){g.id=(Math.random()*new Date().getTime()).toString(36).toUpperCase().replace(/\./g,"-")}return{name:g.name,size:g.size,type:g.type,id:g.id,connectionId:g.connectionId,firefox:e.firefox}},send:function(h,n,o){var m=800,g=0,l=0,i=0;var k=new b.FileReader();var j=function(q,t){var s={type:"file",name:h.name,packets:0,id:h.id,connectionId:h.connectionId,order:i};i++;if(q){t=q.target.result;g=l=s.packets=parseInt(Math.ceil(t.length/m))}else{s.packets=g}if(t.length>m){s.message=t.slice(0,m)}else{s.message=t;s.last=true}n.send(JSON.stringify(s));var p={remaining:--l,length:g,sent:g-l,transfered:g-l,fileId:s.id};if(o.onFileProgress){o.onFileProgress(p,h)}if(s.last&&o.onFileSent){o.onFileSent(p)}t=t.slice(s.message.length);var r=500;if(o.calcTimeout){r=o.calcTimeout(p);if(r<0){return}}if(t.length){setTimeout(function(){j(null,t)},r)}};k.onload=j;k.readAsDataURL(h)},recContent:{},recPackets:{},recNumberOfPackets:{},receive:function(l,j){var n=l.id;if(l.packets&&!f.recNumberOfPackets[n]){f.recNumberOfPackets[n]=f.recPackets[n]=parseInt(l.packets)}if(j.onFileProgress){j.onFileProgress({remaining:--f.recPackets[n],length:f.recNumberOfPackets[n],received:f.recNumberOfPackets[n]-f.recPackets[n],transfered:f.recNumberOfPackets[n]-f.recPackets[n],fileId:n},n)}if(!f.recContent[n]){f.recContent[n]={}}f.recContent[n][l.order]=l.message;if(l.last){var m="";for(var k=0;k<f.recNumberOfPackets[n];k++){m+=f.recContent[n][k]}var h=f.dataUrlToBlob(m);var g=(b.URL||b.webkitURL).createObjectURL(h);if(j.autoSaveToDisk){f.saveToDisk(m,l.name)}if(j.onFileReceived){j.onFileReceived(l.name,{blob:h,dataURL:m,url:g,fileId:n})}delete f.recContent[n]}},saveToDisk:function(g,j){var i=a.createElement("a");i.href=g;i.target="_blank";i.download=j||g;var h=new MouseEvent("click",{view:b,bubbles:true,cancelable:true});i.dispatchEvent(h);(b.URL||b.webkitURL).revokeObjectURL(i.href)},dataUrlToBlob:function(k){var m=atob(k.substr(k.indexOf(",")+1));var l=[];for(var g=0;g<m.length;g++){l.push(m.charCodeAt(g))}var h;try{h=k.substr(k.indexOf(":")+1).split(";")[0]}catch(j){h="text/plain"}return new Blob([new Uint8Array(l)],{type:h})}};return f}})(jQuery,window,document);(function(c,b,a,d){c.fn.mgDesktopShare=function(f){var e={extensionAvailable:null,screenCallback:null,isExtensionAvailable:function(h){var g=this;if(this.extensionAvailable!==null){return h(this.extensionAvailable)}b.postMessage({message:"mgIsLoaded"},"*");setTimeout(function(){if(g.extensionAvailable==null){g.extensionAvailable=false}h(g.extensionAvailable)},200)},getSourceId:function(h){var g=this;this.isExtensionAvailable(function(i){if(!i){h(false,"no-extension")}g.screenCallback=h;b.postMessage({message:"mgGetSourceId"},"*")})}};b.addEventListener("message",function(g){if(g.origin!=b.location.origin){return}switch(g.data.message){case"mgIsLoadedResult":e.extensionAvailable=true;break;case"mgGetSourceIdResult":if(g.data.success){e.screenCallback(g.data.sourceId)}else{if(e.screenCallback){e.screenCallback(false,"no-permission")}}break;default:return}});return e}})(jQuery,window,document);(function(c,b,a,d){c.fn.mgVideoChatUtils=function(i,f){i.prototype.fixPath=function(){if(this.config.dir!="{rel}"){return}var j=this;c("script").each(function(){var n=c(this).attr("src");var m="mgVideoChat-";if(n&&n.indexOf(m,this.length-m.length)!==-1){j.config.dir=n.replace(/\\/g,"/").replace(/\/[^\/]*\/?$/,"");var l=/mgVideoChat\-(\d*\.\d*\.\d*)\.js/gi;var k=l.exec(n);if(k&&k[1]){j.version=k[1]}else{l=/mgVideoChat\-(\d*\.\d*\.\d*)\-min\.js/gi;k=l.exec(n);if(k&&k[1]){j.version=k[1]}else{j.version=1}}}else{m="mgVideoChat";if(n&&n.indexOf(m,this.length-m.length)!==-1){j.config.dir=n.replace(/\\/g,"/").replace(/\/[^\/]*\/?$/,"");j.version=1}}})};i.prototype.debug=function(j){if(this.config.debug){console.log(j)}};i.prototype.getErrorText=function(k){var j=[];if(k.code){j.push(k.code)}if(k.name){j.push(k.name)}if(k.message){j.push(k.message)}if(j.length==0){j.push(k)}if(j[0]=="PermissionDeniedError"||j[0]=="PERMISSION_DENIED"){if(f.firefox){j.push(this._("Please enable requested media devices"))}else{j.push(this._("Please enable requested media devices by clicking on the right hand icon in the address bar."))}}return j.join(".\n")};i.prototype.getReadableFileSizeString=function(l){var k=-1;var j=[" kB"," MB"," GB"," TB","PB","EB","ZB","YB"];do{l=l/1024;k++}while(l>1024);return Math.max(l,0.1).toFixed(1)+j[k]};i.prototype.parseChatMessageText=function(n){function m(q,p){var o=(p||typeof p==="undefined")?"<br />":"<br>";return(q+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+o+"$2")}function k(p){var o=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;return p.replace(o,"<a target=\"_blank\" href='$1'>$1</a>")}function l(s){var p,r,q,o;r=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;p=s.replace(r,'<a href="$1" target="_blank">$1</a>');q=/(^|[^\/])(www\.[\S]+(\b|$))/gim;p=p.replace(q,'$1<a href="http://$2" target="_blank">$2</a>');o=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;p=p.replace(o,'<a href="mailto:$1">$1</a>');return p}function j(q,v,u,p){var s=0,r=0,t=false;if(typeof v==="undefined"||v===null){v=2}q=q.toString();if(p!==false){q=q.replace(/&/g,"&amp;")}q=q.replace(/</g,"&lt;").replace(/>/g,"&gt;");var o={ENT_NOQUOTES:0,ENT_HTML_QUOTE_SINGLE:1,ENT_HTML_QUOTE_DOUBLE:2,ENT_COMPAT:2,ENT_QUOTES:3,ENT_IGNORE:4};if(v===0){t=true}if(typeof v!=="number"){v=[].concat(v);for(r=0;r<v.length;r++){if(o[v[r]]===0){t=true}else{if(o[v[r]]){s=s|o[v[r]]}}}v=s}if(v&o.ENT_HTML_QUOTE_SINGLE){q=q.replace(/'/g,"&#039;")}if(!t){q=q.replace(/"/g,"&quot;")}return q}return m(l(j(n)),false)};var e={};i.prototype.tmpl=function(m,l){try{var j=!/\W/.test(m)?e[m]=e[m]||tmpl(a.getElementById(m).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+m.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return l?j(l):j}catch(k){throw new Error("Error parsing template ["+m.substr(0,100)+"...]");this.debug(k)}};var h={};i.prototype.loadTplByName=function(j,k){return this.loadTpl(this.config.dir+this.config[j]+"?v="+this.version,k)};i.prototype.loadTpl=function(j,k){if(h[j]==null){c.get(j,function(l){h[j]=l;if(k){k(l)}},"html")}else{if(k){k(h[j])}}return h[j]};i.prototype.on=function(j,k){this.events[j]=this.events[j]||[];this.events[j].push(k)};i.prototype.fire=function(k,m){this.debug("mgVideoChat fired ["+k+"]");var o=this.events[k];var l=Array.prototype.slice.call(arguments,1);if(!o){return}for(var n=0,j=o.length;n<j;n++){o[n].apply(null,l)}};var g=null;i.prototype.message=function(n,l,k){if(g){b.clearTimeout(g)}var j=this;var m=j.$messagePanel.find(".alert");var o=j.$messagePanel.data("type");if(!n){j.$messagePanel.hide();return}m.removeClass("alert-"+o).addClass("alert-"+l);m.find("div.text").html(n);j.$messagePanel.data("type",l);j.$messagePanel.show();if(k){g=b.setTimeout(function(){j.$messagePanel.hide();g=null},k*1000)}};i.prototype.setCookie=function(n,k,m,j){var l=(j&&j!="localhost")?("; domain="+j):"";a.cookie=n+"="+encodeURIComponent(k)+"; max-age="+(60*60*24*m)+"; path=/"+l};i.prototype._=function(k,l,j){return c.fn.mgVideoChat._(k,l,j)}}})(jQuery,window,document);(function(c,b,a,d){c.fn.mgVideoChatRtcEvents=function(g,e,f){g.prototype.initRtc=function(){var h=this;e.on("connected",function(){e.login(h.loginParams);h.onConnected()});e.on("connectionId",function(k){h.connectionId=k.connectionId;h.userData=k.data.data.userData;h.roomOptions=k.room;h.usersCount=k.users_count;h.onRoomOptions();h.renderYouInfo()});e.on("logged",function(){h.fire("logged");h.onLogged()});e.on("message",function(k){h.message(k.text,k.type)});e.on("chat_message",function(l){h.fire("chat_message",l);var k=h.roomOptions.group?0:l.connectionId;h.renderChatMessage(k,l.connectionId,l.message);if(h.chatId!=l.connectionId){if(!e.connections[l.connectionId]["data"].unread){e.connections[l.connectionId]["data"].unread=0}e.connections[l.connectionId]["data"].unread++;h.renderConnection(l.connectionId);h.notifySound()}});var i=0;e.on("call_busy",function(k){if(h.roomOptions.roulette&&i<5){h.debug("Callee is busy, try again "+i);i++;h.rouletteNext();return}h.message(h._("Callee is busy at the moment, please try later :("),"danger",3)});e.on("call_drop",function(k){e.stop(k.connectionId,false,h.roomOptions.roulette);if(h.roomOptions.roulette){e.connections={};h.renderConnections()}});e.on("media_ready",function(l){for(var k in l.data.connectionIds){e.connections[l.data.connectionIds[k]]["media_ready"]=true;if(h.localStream&&!e.connections[l.data.connectionIds[k]]["stream"]){e.connections[l.data.connectionIds[k]]["stream"]=h.localStream}}h.debug(e.connections)});e.on("connections",function(k){h.renderConnections()});var j={};e.on("roulette_next",function(k){if(!k||!k.connections){h.message(h._("No partner found at the moment. Please try later."),"warning",3);return false}h.usersCount=k.users_count;e.connections={};j=k});e.on("roulette_accept",function(k){e.connections=j.connections;j={};for(var l in e.connections){h.localVideoOpen(h.localStream,l)}h.connectAllMediaReady();h.renderConnections();h.notifySound()});e.on("roulette_invitation",function(k){h.usersCount=k.users_count;if(h.videoId){for(var l in k.connections){}h.debug("Busy for invitation from "+l);e.busy(l);e.drop(l);return false}e.connections=k.connections;for(var l in e.connections){e.connections[l].stream=h.localStream}e.rouletteAccept(l);h.localVideoOpen(h.localStream,l);h.renderConnections();h.notifySound()});e.on("connection_add",function(k){h.usersCount=k.users_count;h.renderConnection(k.connectionId)});e.on("connection_remove",function(k){h.usersCount=k.users_count;h.onConnectionClose(k.connectionId)});e.on("rstream_added",function(l,k){e.connections[k].rstream=l;if(!h.roomOptions.group){h.remoteVideoOpen(l);h.onVideoOpen(k)}else{h.remoteVideoGroupSelect()}});e.on("stream_added",function(l,k){h.localStream=l;h.localVideoOpen(l,k)});e.on("media_request_start",function(){h.$elem.find("#requestDialog").modal("show")});e.on("media_request_end",function(){h.$elem.find("#requestDialog").modal("hide")});e.on("status",function(l,k){h.fire("call_status",l,k);switch(k){case"call_inviting":h.callRing(false);break;case"call_invited":if(h.videoId){e.busy(l);e.drop(l)}else{h.inviteStart(l)}break;case"call_accepting":case"call_accepted":h.$videoPanel.data("call_id",l);h.inviteStop();break;case"idle":h.callRing(true);if(h.videoId==l){h.onVideoClose()}if(h.videoInvitedId==l){h.inviteStop()}break;default:break}h.renderConnection(l)});e.on("socket_error",function(k){h.message(h._("Error connecting to media server: {error_name} {error_message}",["{error_name}","{error_message}"],[k.name,k.message]),"danger");h.onDisconnected()});e.on("socket_closed",function(k){h.message(h._("Websocket closed, please try reloading page later."),"danger");h.onDisconnected()});e.on("stream_error",function(k){h.message(h._("Error getting local media stream: {error_message}",["{error_message}"],[h.getErrorText(k)]),"danger")});e.on("pc_error",function(k){h.message(h._("Error creating peer connection: {error_name} {error_message}",["{error_name}","{error_message}"],[k.name,k.message]),"danger")});e.on("sdp_offer",function(k){if(e.refuseIdleState(k.connectionId)){return false}e.connections[k.connectionId].offerSdp=k.sdp;e.setStatus(k.connectionId,"sdp_offered");if(!h.loginParams.noPc&&!h.loginParams.noMedia){e.sdpAnswer(k.connectionId)}});e.on("sdp_answer",function(l){if(e.refuseIdleState(l.connectionId)){return false}var k=e.connections[l.connectionId].pc;e.remoteSDReceive(k,l.sdp);e.setStatus(l.connectionId,"sdp_answered")});e.on("ice_candidate",function(l){if(e.refuseIdleState(l.connectionId)){return false}if(h.loginParams.noPc||h.loginParams.noMedia){return false}var k=e.connections[l.connectionId].pc;e.debug("Adding ice candidate:");e.debug({sdpMLineIndex:l.label,candidate:l.candidate});k.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:l.label,candidate:l.candidate}),function(){e.debug("Remote candidate added successfully.")},function(m){e.debug("Failed to add remote candidate: "+m.toString())})});e.on("file_offer",function(m){var l=m.connectionId;var k=e.connections[l].data.userData;h.files[m.fileDesc.id]={desc:m.fileDesc,connectionId:l,pending:true};if(m.fileDesc.firefox!=e.firefox){h.message(h._("You and your peer are not using the same browser. File transfer between different browser most likely will not work."),"warning")}h.renderFiles();h.$fileAcceptDialog.data("file_desc",m.fileDesc);h.$fileAcceptDialog.data("connection_id",l);h.$fileAcceptDialog.find(".username").text(k.name);if(k.image){h.$fileAcceptDialog.find(".desc").html('<img src="'+k.image+'" alt="'+k.name+'"/>')}h.$fileAcceptDialog.find(".fileName").text(m.fileDesc.name);h.$fileAcceptDialog.find(".fileSize").text(h.getReadableFileSizeString(m.fileDesc.size));h.$fileAcceptDialog.modal("show");h.notifySound()});e.on("file_accept",function(k){if(k.fileDesc.firefox!=e.firefox){h.message(h._("You and your peer are not using the same browser. File transfer between different browser most likely will not work."),"warning")}e.fileSdpOffer(k.connectionId,k.fileDesc,{channelOnOpen:function(){h.debug("channelOnOpen connId: "+k.connectionId);h.debug(k);var n=e.connections[k.connectionId].sendChannel;var l=k.fileDesc.id;var m=h.files[l].file;f.send(m,n,{onFileProgress:function(o){h.debug("onFileProgress "+l+" connId: "+k.connectionId);h.debug(o);if(h.files[o.fileId]){h.files[o.fileId].progress=o;h.renderFileProgress(o.fileId)}},onFileSent:function(o){h.debug("onFileSent "+l+" connId: "+k.connectionId);h.debug(o);delete h.files[o.fileId];h.renderFiles()},calcTimeout:function(o){if(!h.files[o.fileId]){return -1}return(e.firefox)?5:500}})}})});e.on("file_receive_progress",function(k){if(!h.files[k.fileId]){return}h.files[k.fileId].packetsConfirmed=k.packets});e.on("file_sdp_offer",function(m){var l=m.connectionId;var k=m.fileDesc.id;e.connections[m.connectionId].fileOfferSdp=m.sdp;e.fileSdpAnswer(m.connectionId,m.fileDesc,{channelOnMessage:function(o){var n=JSON.parse(o.data);h.debug("channelOnMessage connId: "+n.connectionId+", order: "+n.order);f.receive(n,{onFileProgress:function(p){h.debug("onFileProgress "+k+" connId: "+n.connectionId);h.debug(p);if(h.files[p.fileId]){h.files[p.fileId].progress=p;h.renderFileProgress(p.fileId)}},autoSaveToDisk:true,onFileReceived:function(p,q){h.debug("onFileReceived file: "+p+", file id: "+k+" connId: "+n.connectionId);h.debug(q);delete h.files[q.fileId];h.renderFiles()}})}})});e.on("file_sdp_answer",function(l){var k=e.connections[l.connectionId].dpc;k.setRemoteDescription(new RTCSessionDescription(l.sdp))});e.on("file_cancel",function(k){delete h.files[k.fileDesc.id];h.renderFiles()})}}})(jQuery,window,document);(function(c,b,a,d){c.fn.mgVideoChatUI=function(h,f,g,e){h.prototype.updateLayout=function(){var i=this.$callPanel.is(":visible")||this.$chatPanel.is(":visible");var k=this.$elem.find("#mainContent");var j=this.$elem.find("#sideMenu");if(k.data("is_visible")===i){return false}if(i){k.removeClass().addClass(k.data("chat_class"));j.removeClass().addClass(j.data("chat_class"));c("#offcanvasButton").show()}else{k.removeClass().addClass(k.data("no_chat_class"));j.removeClass().addClass(j.data("no_chat_class"))}k.data("is_visible",i)};h.prototype.renderConnections=function(){var i=this;i.debug("connections");i.debug(f.connections);this.loadTplByName("tplConnections",function(j){var k=i.tmpl(j,{rows:f.connections,roomOptions:i.roomOptions,usersCount:i.usersCount});i.$connectionsPanel.html(k);for(var l in f.connections){i.renderConnection(l)}if(!f.connections.length){i.$connectionsPanel.find("#lonely").show()}i.fire("connections",f.connections)})};h.prototype.renderConnection=function(j){var i=this;this.getConnectionElement(j,function(l){var k=i.$connectionsPanel.find("#connection_"+j);if(k.length){if(k.hasClass("active")){l.addClass("active")}k.replaceWith(l)}else{i.$connectionsPanel.find("#connections").append(l)}i.$connectionsPanel.find("#lonely").hide();i.fire("connections",f.connections)})};h.prototype.getConnectionElement=function(j,k){var i=this;if(!f.connections[j]){return false}this.loadTplByName("tplConnection",function(o){var m=f.connections[j],l=m.status?m.status:"idle";var p=m.data["loginParams"];var r=!i.loginParams.noPc&&!i.loginParams.noMedia&&!p.noPc&&!p.noMedia;var q={id:j,status:l,userData:m.data["userData"],loginParams:m.data["loginParams"],videoId:i.videoId,chatId:i.chatId,unread:(m.data.unread)?m.data.unread:0,connection:m,roomOptions:i.roomOptions,hasWebrtc:r};function s(t){i.$connectionsPanel.find(".connectionItem").removeClass("active");t.addClass("active")}var n=c(i.tmpl(o,q));if(i.roomOptions.group&&m.rstream){n.find("video").attr("src",b.URL.createObjectURL(m.rstream))}if(i.roomOptions.group){n.click(function(){s(c(this));var t=c(this).data("connection_id");if(f.connections[t].rstream){i.remoteVideoOpen(f.connections[t].rstream,t)}})}else{n.click(function(){s(c(this));i.setChat(c(this).data("connection_id"))})}n.find(".call.cmdBtn").click(function(){f.invite(c(this).data("id"),i.getMediaOptions({audio:true,video:true}))});n.find(".callDesktop.cmdBtn").click(function(){var t=this;i.getDesktopShareMedia(function(u){if(!u){return false}f.invite(c(t).data("id"),u)})});n.find(".callAudio.cmdBtn").click(function(){f.invite(c(this).data("id"),i.getMediaOptions({audio:true,video:false}))});n.find(".answer.cmdBtn").click(function(){i.debug("Clicked to answer the connectionId: "+c(this).data("id"));f.accept(c(this).data("id"),i.getMediaOptions({audio:true,video:true}))});n.find(".drop.cmdBtn").click(function(){i.debug("Clicked to drop the connectionId: "+c(this).data("id"));f.drop(c(this).data("id"),false,i.roomOptions.roulette)});n.find(".fileSend.cmdBtn").click(function(){var t=c(this).data("id");i.debug("Clicked to send file to the connectionId: "+t);c("#fileDialog").off("change");c("#fileDialog").val("");c("#fileDialog").on("change",function(u){var x=u.target.files;for(var v=0,y;y=x[v];v++){y.connectionId=t;var w=g.getDesc(y);if(i.config.fileMaxSize&&w.size>i.config.fileMaxSize){i.message(i._("This file size of over maximum defined of {max_size}",["{max_size}"],[i.getReadableFileSizeString(i.config.fileMaxSize)]),"danger");continue}f.fileOffer(t,w);i.files[y.id]={file:y,desc:w,connectionId:t};i.renderFiles()}});c("#fileDialog").trigger("click")});if(i.chatId==j){n.addClass("active")}k(n)})};h.prototype.renderFiles=function(){var i=this;i.debug("files");i.debug(i.files);this.loadTplByName("tplFile",function(l){var j="";for(var k in i.files){var m=i.tmpl(l,{file:i.files[k],fileId:k,fileSize:i.getReadableFileSizeString(i.files[k].desc.size),roomOptions:i.roomOptions});j+=m}i.$filesPanel.find("#files").html(j);i.$filesPanel.find("a.fileAccept").click(function(){var n=c(this).data("file_id");var o=i.files[n].desc;var p=i.files[n].connectionId;i.fileAccept(o,p);return false});i.$filesPanel.find("a.fileCancel").click(function(){var n=c(this).data("file_id");var o=i.files[n].desc;var p=i.files[n].connectionId;i.fileCancel(o,p);return false});if(j==""){i.$filesPanel.hide()}else{i.$filesPanel.show()}})};h.prototype.renderYouInfo=function(){var i=this;i.debug(i.userData);this.loadTplByName("tplYou",function(j){i.$youInfoPanel.find("#youInfo").html(i.tmpl(j,{userData:i.userData}));if(!i.userData){i.$youInfoPanel.hide()}else{i.$youInfoPanel.show()}})};h.prototype.renderFileProgress=function(j){var l=this.files[j];if(!l){return false}var k=0;if(l.progress){k=(l.progress.transfered/l.progress.length)*100}var i=this.$filesPanel.find("#file_"+j);i.find(".progress-bar").css("width",k+"%");i.find(".progressText").text(k+"%")};h.prototype.renderChatMessage=function(l,k,m){var j=this;var i=this.getChatDiv(l);this.loadTplByName("tplChat",function(n){var q={message:j.parseChatMessageText(m),me:false};if(k===j.connectionId){q.me=true;q.userData=j.userData}else{q.userData=f.connections[k]["data"]["userData"]}var p=j.tmpl(n,q);var o=i.find(".messages");o.append(p).scrollTop(o.get(0).scrollHeight)})};h.prototype.getChatDiv=function(l){var j=this;var i=this.$chatPanel.find("#chat_"+l);if(!i.length){var k=this.loadTplByName("tplChatInput");i=c(j.tmpl(k,{chatId:l}));i.appendTo(j.$chatPanel.find("#chats"));i.find("textarea").keypress(function(n){var m=c(this);if(n.keyCode===13&&n.shiftKey){m.val(m.val()+"\n");return false}if(n.keyCode===13){f.chatMessage(l,m.val());j.renderChatMessage(l,j.connectionId,m.val());m.val("");return false}})}return i}}})(jQuery,window,document);window.RTCPeerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.RTCPeerConnection;window.PeerConnection=(window.webkitPeerConnection00||window.webkitPeerConnection||window.PeerConnection);navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;window.URL=window.URL||window.webkitURL;window.RTCSessionDescription=window.mozRTCSessionDescription||window.webkitRTCSessionDescription||window.RTCSessionDescription;window.RTCIceCandidate=window.mozRTCIceCandidate||window.webkitRTCIceCandidate||window.RTCIceCandidate;(function(f,g,h,d){var e={wsURL:"ws://localhost:8080",dir:"{rel}",tplMain:"/tpls/main.html",tplConnections:"/tpls/connections.html",tplConnection:"/tpls/connection.html",tplChat:"/tpls/chat.html",tplChatInput:"/tpls/chat_input.html",tplRoulette:"/tpls/roulette.html",tplFile:"/tpls/file.html",tplYou:"/tpls/you.html",sound:{mp3:"/sounds/ring.mp3",ogg:"/sounds/ring.ogg"},notifySound:{mp3:"/sounds/notify.mp3",ogg:"/sounds/notify.ogg"},debug:false,login:null,rtc:{pcConfig:{iceServers:[{url:"stun:stun.l.google.com:19302"}]},pcConstraints:{optional:[{DtlsSrtpKeyAgreement:true}]},offerConstraints:{optional:[],mandatory:{}},mediaConstraints:{audio:true,video:true},sdpConstraints:{mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:true},optional:[{VoiceActivityDetection:false}]},audio_receive_codec:"opus/48000"},fileMaxSize:512000,chromeExtensionId:"jfepeciommhoefhfacjdpcmnclekenag"},c=null,a=null,b=null;var i=function(k,j){this.version="1";this.elem=k;this.$elem=f(k);this.$connectionsPanel=null;this.options=j;this.metadata=this.$elem.data("mgVideoChat-options");this.config=f.extend({},e,this.options);c=f.fn.mgRtc(this.config);a=f.fn.mgFileHelper(c);b=f.fn.mgDesktopShare(c);f.fn.mgVideoChatUtils(i,c);f.fn.mgVideoChatUI(i,c,a,b);f.fn.mgVideoChatRtcEvents(i,c,a);c.init(this.config);this.fixPath();this.init();this.$elem.data("mgVideoChat-instance",this);this.chatId=null;this.videoId=null;this.videoInvitedId=null;this.connectionId=null;this.userData={};this.roomOptions={};this.localStream=null;this.loginParams={};this.files={};this.isMuted={audio:false,video:false};this.events={}};i.prototype.init=function(){var j=this;this.loadTplByName("tplConnections",function(k){j.loadTplByName("tplMain",function(o){j.$elem.html(j.tmpl(o,{config:j.config}));j.$connectionsPanel=j.$elem.find("#connectionsPanel");j.$messagePanel=j.$elem.find("#messagePanel");j.$loginPanel=j.$elem.find("#loginPanel");j.$videoPanel=j.$elem.find("#videoPanel");j.$loginDialog=j.$elem.find("#loginDialog");j.$callPanel=j.$elem.find("#callPanel");j.$answerDialog=j.$elem.find("#answerDialog");j.$shareDialog=j.$elem.find("#shareDialog");j.$fileAcceptDialog=j.$elem.find("#fileAcceptDialog");j.$chatPanel=j.$elem.find("#chatPanel");j.$filesPanel=j.$elem.find("#filesPanel");j.$youInfoPanel=j.$elem.find("#youInfoPanel");j.loginParams={};var q={},n={},p={websocket:j._("Your browser does not support websocket."),peerconnection:j._("Your browser does not support PeerConnections."),usermedia:j._("Your browser does not support user media.")};if(!c.checkCompatibility(q,n,"chat")){j.debug(q);var m=[];for(var l in q){m.push(p[l])}m.push(j._('Please try <a href="http://www.google.com/chrome" target="_blank">Google Chrome</a> or <a href="http://www.mozilla.org/en-US/firefox" target="_blank">Mozilla Firefox</a>'));j.message(m.join("<br>"),"danger")}else{if(!f.isEmptyObject(n)){var m=[];for(var l in n){m.push(p[l])}m.push(j._("You will not be able to make video calls."));m.push(j._('Please try <a href="http://www.google.com/chrome" target="_blank">Google Chrome</a> or <a href="http://www.mozilla.org/en-US/firefox" target="_blank">Mozilla Firefox</a>'));j.message(m.join("<br>"),"warning",5)}if(n.peerconnection){j.loginParams.noPc=true}if(n.usermedia){j.loginParams.noMedia=true}c.connect(j.config.wsURL)}j.initDom();j.initRtc()});j.loadTplByName("tplChatInput",function(l){})})};i.prototype.initDom=function(){var k=this;k.$loginPanel.find("#loginButton").click(function(){if(k.config.login){k.config.login(function(){c.login(k.loginParams)})}else{k.$loginDialog.modal("show")}});k.$loginDialog.on("shown.bs.modal",function(){k.$loginDialog.find("#userName").focus()});var l=function(){if(k.$loginDialog.find("#userName").val()){k.setCookie("mgVideoChatSimple",k.$loginDialog.find("#userName").val(),30,g.location.hostname);k.$loginDialog.modal("hide");g.location.reload()}};k.$loginDialog.find("#userName").keypress(function(m){if(m.keyCode===13){l();return false}});k.$loginDialog.find("button.login").click(l);k.$videoPanel.find("#videoFullScreen").click(function(){var m=k.$videoPanel.get(0),n=m.requestFullScreen||m.webkitRequestFullScreen||m.mozRequestFullScreen;n.call(m)});k.$videoPanel.find("#videoExitFullScreen").click(function(){var m=h.cancelFullScreen||h.webkitCancelFullScreen||h.mozCancelFullScreen;m.call(h)});k.$videoPanel.find("#callHangup").click(function(){c.drop(k.videoId)});var j=function(q,p){if(!k.localStream){return false}var n=(p=="audio")?k.localStream.getAudioTracks():k.localStream.getVideoTracks();if(n.length===0){return false}var o;for(o=0;o<n.length;o++){n[o].enabled=k.isMuted[p]}k.isMuted[p]=!k.isMuted[p];var m=(k.isMuted[p])?"off":"on";q.attr("title",q.data("title-"+m));q.find("span").removeClass(q.data("icon-on")).removeClass(q.data("icon-off")).addClass(q.data("icon-"+m))};k.$videoPanel.find("#videoMute").click(function(){j(f(this),"video")});k.$videoPanel.find("#audioMute").click(function(){j(f(this),"audio")});k.$answerDialog.find("#answer").click(function(){c.accept(k.$answerDialog.data("caller_id"),k.getMediaOptions({audio:true,video:true}));k.$answerDialog.modal("hide")});k.$answerDialog.find("#answerAudio").click(function(){c.accept(k.$answerDialog.data("caller_id"),k.getMediaOptions({audio:true,video:false}));k.$answerDialog.modal("hide")});k.$answerDialog.find("#cancelCall").click(function(){c.drop(k.$answerDialog.data("caller_id"));k.$answerDialog.modal("hide")});k.$shareDialog.find("#shareCam").click(function(){k.createGroupStream();k.$shareDialog.modal("hide")});k.$shareDialog.find("#shareDesktop").click(function(){k.getDesktopShareMedia(function(m){if(!m){return false}k.createGroupStream(m)});k.$shareDialog.modal("hide")});k.$fileAcceptDialog.find("#fileAccept").click(function(){var m=k.$fileAcceptDialog.data("file_desc");var n=k.$fileAcceptDialog.data("connection_id");k.$fileAcceptDialog.modal("hide");m.firefox=c.firefox;k.fileAccept(m,n)});k.$fileAcceptDialog.find("#fileCancel").click(function(){var m=k.$fileAcceptDialog.data("file_desc");var n=k.$fileAcceptDialog.data("connection_id");k.fileCancel(m,n);k.$fileAcceptDialog.modal("hide")});f("#connectionsPanel").on("click","#rouletteNext",function(){k.rouletteNext()});f("#offcanvasButton").click(function(){f(".row-offcanvas").toggleClass("active");event.stopPropagation()});f("body").click(function(){f(".row-offcanvas").removeClass("active")});f("#sideMenu").click(function(m){m.stopPropagation()})};i.prototype.fileAccept=function(j,k){this.files[j.id].pending=false;this.renderFiles();c.fileAccept(k,j)};i.prototype.fileCancel=function(j,k){delete this.files[j.id];this.renderFiles();c.fileCancel(k,j)};i.prototype.onConnected=function(){this.$loginPanel.show()};i.prototype.onDisconnected=function(){this.disableChat()};i.prototype.onLogged=function(){this.$loginPanel.hide()};i.prototype.onConnectionClose=function(j){this.$connectionsPanel.find("#connection_"+j).remove();this.disableChat(j);if(this.videoId==j){this.onVideoClose()}if(this.videoInvitedId==j){this.inviteStop()}delete c.connections[j];this.fire("connections",c.connections)};i.prototype.onVideoOpen=function(j){this.videoId=j;if(j){this.$callPanel.find(".panel-title").text(this._("Call with {username}",["{username}"],[c.connections[j]["data"]["userData"]["name"]]))}this.$callPanel.show();this.updateLayout();if(!this.roomOptions.group){this.renderConnections()}};i.prototype.onVideoClose=function(){var j=this;this.videoId=null;if(!this.roomOptions.group){j.$elem.find("#localVideo").attr("src","")}j.$elem.find("#remoteVideo").attr("src","");j.$callPanel.hide();j.inviteStop();this.renderConnections();this.remoteVideoGroupSelect()};i.prototype.inviteStart=function(j){this.videoAnswerDialog(j);this.videoInvitedId=j;this.callRing(false)};i.prototype.inviteStop=function(){this.$answerDialog.modal("hide");this.videoInvitedId=null;this.callRing(true)};i.prototype.videoAnswerDialog=function(l){var k=this;var j=c.connections[l].data.userData;k.$answerDialog.data("caller_id",l);k.$answerDialog.find(".username").text(j.name);if(j.image){k.$answerDialog.find(".desc").html('<img src="'+j.image+'" alt="'+j.name+'"/>')}k.$answerDialog.modal("show")};i.prototype.callRing=function(j){var k=this.$elem.find("#ringSound").get(0);if(j){k.pause()}else{k.play()}};i.prototype.notifySound=function(){this.$elem.find("#notifySound").get(0).play()};i.prototype.rouletteNext=function(){if(this.videoId){c.drop(this.videoId,false,true)}c.rouletteNext()};i.prototype.hasMedia=function(m,k){try{var j=(k=="audio")?m.getAudioTracks():m.getVideoTracks();return j.length>0}catch(l){return false}};i.prototype.localVideoOpen=function(k,j){if(k){this.$elem.find("#localVideo").attr("src",g.URL.createObjectURL(k));this.$elem.find("#localVideo").show();this.isMuted={audio:false,video:false};if(!this.hasMedia(k,"video")){this.$elem.find("#videoMute")}if(!this.hasMedia(k,"audio")){this.$elem.find("#audioMute")}}else{this.$elem.find("#localVideo").hide()}this.onVideoOpen(j)};i.prototype.remoteVideoOpen=function(k,j){if(k){this.$elem.find("#remoteVideo").attr("src",g.URL.createObjectURL(k));this.$elem.find("#remoteVideo").show()}else{this.$elem.find("#remoteVideo").hide()}if(j){this.onVideoOpen(j)}};i.prototype.remoteVideoGroupSelect=function(){if(!this.roomOptions.group||this.videoId){return}for(var k in c.connections){if(c.connections[k].rstream){var j=this.$connectionsPanel.find("#connection_"+k+".connectionItem");j.click()}}};i.prototype.getMediaOptions=function(j){j.video=j.video&&!this.roomOptions.disableVideo;j.audio=j.audio&&!this.roomOptions.disableAudio;return j};i.prototype.onRoomOptions=function(){var j=this;var l=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;this.roomOptions.desktopShare=this.roomOptions.desktopShare&&l;if(this.roomOptions.group||this.roomOptions.roulette){if(this.roomOptions.group){this.debug("This chat is group/conference chat");this.$videoPanel.find("#callHangup").remove()}else{this.config.tplConnections=this.config.tplRoulette;this.debug("This chat is roulette chat")}c.debug("creating local media stream");if(j.loginParams.noPc||j.loginParams.noMedia||(this.roomOptions.disableVideo&&this.roomOptions.disableAudio)){c.debug("no webrtc support");j.localStream=null;j.onMediaStreamGroup(true)}else{if(this.roomOptions.desktopShare){c.debug("sharing desktop dialog option");this.$shareDialog.modal("show")}else{j.createGroupStream()}}}if(this.roomOptions.disableVideo){this.$answerDialog.find("#answer").hide();var k=this.$elem.find("#localVideoBg"),m=this.$elem.find("#remoteVideoBg");k.addClass("localAudio").show();m.addClass("remoteAudio").show();this.$elem.find("#localVideo").hide();this.$elem.find("#remoteVideo").hide()}if(this.roomOptions.disableAudio){this.$answerDialog.find("#answerAudio").hide()}};i.prototype.createGroupStream=function(j){var k=this;j=j?j:this.getMediaOptions({audio:true,video:true});c.createStream(null,j,function l(n){c.debug("local stream added");k.onMediaStreamGroup(true)},function m(n){k.localStream=null;c.debug("local stream rejected");k.onMediaStreamGroup(true)})};i.prototype.onMediaStreamGroup=function(k){var j=this;c.mediaReady();if(j.roomOptions.group){j.connectAllMediaReady();j.setChat(0)}if(j.roomOptions.roulette){j.rouletteNext()}};i.prototype.connectAllMediaReady=function(){var j=this;if(!this.roomOptions.group&&!this.roomOptions.roulette){return false}for(var k in c.connections){if(!c.connections[k].rstream&&c.connections[k].media_ready){if(!c.connections[k].stream){c.connections[k].stream=j.localStream}if(c.refuseIdleState(k)){return false}c.sdpOffer(k)}}};i.prototype.getDesktopShareMedia=function(k){var j=this;b.getSourceId(function(n,m){if(!n){if(m=="no-permission"&&location.protocol!="https:"){j.message(j._("Desktop can be shared only over https secure connection."),"danger")}if(m=="no-extension"){j.message(j._('Please <a href="#" class="btn btn-success extensionInstall">install</a> this chrome extension in order to use desktop sharing and reload this page.'),"danger");j.$elem.find(".extensionInstall").click(function(){try{chrome.webstore.install("https://chrome.google.com/webstore/detail/"+j.config.chromeExtensionId,function o(){location.reload()},function q(r){j.message(r,"danger")})}catch(p){g.open("https://chrome.google.com/webstore/detail/"+j.config.chromeExtensionId,"install")}return false})}return k(false)}var l={audio:false,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxWidth:g.screen.width,maxHeight:g.screen.height,maxFrameRate:3}}};c.debug("mediaOptions");c.debug(l);return k(l)})};i.prototype.disableChat=function(j){if(!j){this.$chatPanel.find(".form-control").attr("disabled","disabled")}else{this.$chatPanel.find("#chat_"+j+" .form-control").attr("disabled","disabled")}};i.prototype.setChat=function(j){this.chatId=j;this.$chatPanel.find(".chat").hide();this.getChatDiv(j).show();if(j>0){this.$chatPanel.find(".panel-title").text(this._("Chat with {username}",["{username}"],[c.connections[j]["data"]["userData"]["name"]]))}else{this.$chatPanel.find(".panel-title").text(this._("Group chat"))}this.$chatPanel.show();this.updateLayout();if(j&&c.connections[j]["data"].unread){c.connections[j]["data"].unread=0;this.renderConnection(j)}};i.prototype.getRtc=function(){return c};f.fn.mgVideoChat=function(k,m,l){if(k==="on"){var j=f(this).data("mgVideoChat-instance");if(j){return j.on(m,l)}}else{var n=[];this.each(function(){n.push(new i(this,k))});if(n.length===1){return n[0]}return n}};f.fn.mgVideoChat._=function(m,o,l){var j=m;if(f.fn.mgVideoChat.translate&&f.fn.mgVideoChat.translate[m]){j=f.fn.mgVideoChat.translate[m]}if(!o||!o.length){return j}var n;for(var k=0;k<o.length;k++){n=new RegExp(o[k],"g");j=j.replace(n,l[k])}return j}})(jQuery,window,document);(function(c,b,a,d){if(b.location.hostname!="magnoliyan.com"&&b.location.hostname!="www.magnoliyan.com"){c.fn.mgCustomizer=function(e){throw"Not Supported"}}})(jQuery,window,document);